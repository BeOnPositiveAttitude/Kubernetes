Так как каждый сервис в нашей микросервисной архитектуре является software, то мы должны ожидать, что они могут замедлиться, упасть или даже сойти с ума без видимых на то причин. Так как все сервисы зависят один от другого, замедление в работе одного, может повлиять на другие, зависящие от него. Даже может возникнуть каскадный эффект.

<img src="screen.jpg" width="800" height="400"><br>

Например, если сервис Ratings начнет тормозить по каким-либо причинам, то запросы на него начнут скапливаться в очередь, что в свою очередь вызовет очередь запросов на сервис Reviews.

Или представим, что сервис Details начал тормозить. Запросы, идущие от Product Page к сервису Details, начинают скапливаться в очередь и в итоге запросы к самой Product Page также встают в очередь, и это влияет на всех пользователей приложения. Поэтому нам нужны таймауты.

Если сервису требуется слишком много времени для ответа, то он не должен удерживать другие зависимые сервисы в постоянном ожидании. Он должен падать после некоторого периода времени и возвращать сообщение об ошибке. При таком подходе зависимые сервисы получают сообщение об ошибке и не попадают под влияние. Это и есть таймаут.

Мы можем настроить таймаут либо для сервиса Details, чтобы падал он, либо мы можем настроить таймаут для сервиса Product Page, чтобы он падал быстрее, чем вечно ждать ответа от сервиса Details.

Ниже представлены сервис `details` и сервис `bookinfo`, который направляет трафик к Product Page. Мы хотим добавить таймаут для сервиса Product Page, чтобы  запросы, занимающие более трех секунд, отклонялись. Для этого мы добавили опцию `timeout` и задали значение 3 секунды.

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: bookinfo
spec:
  hosts:
  - "bookinfo.app"
  gateways:
  - bookinfo-gateway
  http:
  - match:
    - uri:
        exact: /productpage
    - uri:
        prefix: /static
    - uri:
        exact: /login
    - uri:
        exact: /logout
    - uri:
        prefix: /api/v1/products
    route:
    - destination:
        host: productpage
        port:
          number: 9080
    timeout: 3s
```

Как нам выполнить тестирование, если приложение работает отлично? Так как у нас мало трафика и сервис Details также работает превосходно, мы хотим чтобы он упал. Как мы узнали из прошлой лекции, можно cымитиpoвaть падение с помощью fault injection. Для этого добавим секцию `fault` в сервис `details` с фиксированной задержкой в 5 секунд для 50% трафика.

```yaml
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: details
spec:
  hosts:
    - details
  http:
  - route:
    - destination:
        host: details
        subset: v1
    fault:
      delay:
        fixedDelay: 5s
        percent: 50
```