Данная секция не касается назначения IP-адресов на ноды в сети. Мы можем управлять этим процессом самостоятельно либо с помощью стороннего IPAM решения.

В этом уроке рассказывается каким образом виртуальным bridge-сетям и нодам назначается IP-подсеть, а также как IP-адреса назначаются pod-ам. Где хранится эта информация и кто гарантирует, что не будут назначены дублирующиеся IP-адреса? Начнем с "кто" и обратимся к CNI, который задает стандарты. CNI говорит, что обязанность CNI плагина, network solution provider позаботиться о назначении IP-адресов контейнерам.

Вспомним базовый плагин, который написали ранее. Мы на самом деле позаботились о назначении IP-адресов в этом плагине.

<img src="image-4.png" width="300" height="300"><br>

Там была секция назначения IP-адреса для container network namespace.

```bash
# Assign IP Address
ip -n <namespace> addr add ...
ip -n <namespace> route add ...
```

Но как нам управлять этими IP-адресами? K8s не волнует как мы это делаем. Нам просто нужно сделать это, убедившись, что мы не назначаем дублирующиеся IP-адреса и правильно управляем ими.

Легкий способ сделать это - хранить список IP-адресов в файле и убедиться, что в нашем скрипте есть необходимый код для правильного управления этим файлом. Этот файл размещается на каждом хосте и управляет IP-адресами pod-ов на этих нодах.

<img src="image-5.png" width="800" height="400"><br>

```bash
# Retrieve Free IP from file
ip = get_free_ip_from_file()
# Assign IP Address
ip -n <namespace> addr add ...
ip -n <namespace> route add ...
```

Вместо того, чтобы кодить это самостоятельно в нашем скрипте, CNI поставляется с двумя встроенными плагинами, которым вы можете передать эту задачу на аутсорсинг. В данном случае плагин `host-local` реализует подход, которого мы придерживаемся для управления IP-адресами локально на каждом хосте. Но нашей обязанностью все еще является вызов этого плагина в скрипте.

```bash
# Invoke IPAM host-local plugin
ip = get_free_ip_from_host_local()
# Assign IP Address
ip -n <namespace> addr add ...
ip -n <namespace> route add ...
```

Либо мы можем сделать скрипт динамическим для поддержки различных типов плагинов. Конфигурационный файл CNI имеет секцию под названием "ipam", в которой мы можем указать тип используемого плагина, а также подсеть и маршрут. Эти подробности могут быть прочитаны из нашего скрипта, чтобы вызывать соответствующий плагин вместо хардкодинга использования host-local каждый раз.

<img src="image-6.png" width="300" height="300"><br>

Различные network solution providers делают это по-разному. Посмотрим как weave управляет IP-адресами. Weave по умолчанию выделяет диапазон `10.32.0.0/12` для всей сети. Это дает сети IP-адреса из диапазона `10.32.0.1 - 10.47.255.254`. Это `1 048 574` IP-адресов, которые вы можете использовать для pod-ов в сети. Из этого диапазона peer-ы решают разделить IP-адреса поровну между собой и назначить одну часть каждой ноде.

<img src="image-7.png" width="600" height="500"><br>

Pod-ы созданные на этих нодах, будут иметь IP-адреса из этого диапазона. Разумеется эти диапазоны могут конфигурироваться с дополнительными опциями, переданными в процессе установки плагина weave в кластер.