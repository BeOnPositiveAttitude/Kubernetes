Предположим у нас есть 3х-нодовый K8s-кластер с развернутыми в нем pod-ами и Services. Каждая нода имеет свое имя и назначенный на нее IP-адрес. Имена нод и IP-адреса кластера вероятно зарегистрированы на DNS-сервере вашей организации. Кто им управляет и кто имеет к нему доступ, нас не беспокоит в рамках данного урока. В этой лекции мы обсудим DNS resolution в кластере между различными компонентами, такими как pod-ы и Services.

По умолчанию K8s разворачивает встроенный DNS-сервер, когда вы устанавливаете кластер. Если вы устанавливаете K8s вручную, то делаете это самостоятельно. Нас не особо интересуют ноды, мы полностью сосредоточимся на pod-ах и Services в кластере.

При условии, что сеть кластера правильно настроена, следуя best practices, которые мы изучили в этой секции, все pod-ы и Services могут получить свой собственный IP-адрес и достучаться друг до друга, все должно быть хорошо.

<img src="image.png" width="600" height="350"><br>

Начнем всего лишь с двух pod-ов и Service. Слева у нас есть pod `test` с IP-адресом `10.244.1.5`, а справа pod `web` с IP-адресом `10.244.2.5`. Посмотрев на их IP, вы можете предположить, что они вероятно расположены на двух разных нодах. Но это не имеет большого значения. Что касается DNS (as far as DNS is concerned), мы предполагаем, что все pod-ы и Services могут достучаться друг до друга, используя их IP-адреса.

Чтобы сделать web-сервера доступным для pod-а `test`, мы создаем Service `web-service`. Service получает IP-адрес `10.107.37.188`. Как только Service создан, кубовый DNS-сервис создает запись для этого Service. Он мапит имя Service с его IP-адресом. Теперь в пределах кластера любой pod может достигнуть этот Service, используя его имя.

<img src="image-1.png" width="600" height="350"><br>

Помните как мы ранее говорили о namespaces? Все в пределах одного namespace обращаются друг к другу только лишь по имени, а к кому-либо в другом namespace, используя полное имя/фамилию. Т.к. в данном случае pod `test` и pod `web`, а также связанный с ним Service `web-service` находятся в одном namespace `default`, вы можете довольно просто достигнуть `web-service` из pod-а `test`, используя только лишь имя Service `web-service.`

<img src="image-2.png" width="600" height="350"><br>

Давайте предположим, что `web-service` находится в отдельном namespace `apps`. Чтобы теперь обратиться к нему из namespace `default`, вы должны сказать `web-service.apps`. "Фамилией" Service является название namespace. Таким образом здесь `web-service` - это имя Service, `apps` - имя namespace.

<img src="image-3.png" width="700" height="400"><br>

Для каждого namespace DNS-сервер создает поддомен. Все pod-ы и Services для namespace таким образом группируются вместе в поддомен с именем namespace.

Все Services далее группируются вместе в другой поддомен, названный `svc`. Поэтому вы можете получить доступ к приложению по адресу: `web-service.apps.svc`.

В конце концов все pod-ы и Services группируются вместе в корневой домен для кластера, который по умолчанию имеет значение `cluster.local`. Поэтому вы можете получить доступ к сервису по адресу: `web-service.apps.svc.cluster.local`. Это является FQDN для Service. Так разрешаются Services в кластере.

А что насчет pod-ов? По умолчанию записи для pod-ов не создаются. Но мы можем включить этот функционал явно. После включения записи для pod-ов будут также создаваться. Однако в этом случае не используются имена pod-ов. Для каждого pod-а K8s генерирует имя, заменяя точки в IP-адресе на тире: `10.244.2.5 => 10-244-2-5`. Namespace остается тем же, а вот тип устанавливается `pod`. Корневой домен всегда `cluster.local`.

<img src="image-4.png" width="600" height="200"><br>

<img src="image-5.png" width="300" height="200"><br>

Получить доступ к приложению: `curl http://10-244-2-5.apps.pod.cluster.local`.

Аналогично pod `test` в namespace `default` получит запись на DNS-сервере:

<img src="image-6.png" width="600" height="250"><br>

Получить доступ к приложению: `curl http://10-244-1-5.default.pod.cluster.local`.

