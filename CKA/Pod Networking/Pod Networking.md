В предыдущих уроках мы говорили о сети, которая соединяет ноды кластера между собой. Но существует также другой уровень сети, являющийся ключевым для функционирования кластера - сеть на уровне pod-ов. Как нам обращаться к pod-ам? Как они взаимодействуют друг с другом? Как нам получить доступ к приложениям, запущенным в этих pod-ах, изнутри кластера, а также извне? K8s ожидает, что вы сами должны решить эти вызовы (challenges). На текущий момент K8s не поставляется со встроенным решением. Однако K8s имеет четко опубликованные требования для pod networking. Посмотрим, что они из себя представляют.

K8s ожидает, что каждый pod получит свой собственный уникальный IP-адрес.

Каждый pod, используя этот IP-адрес, должен иметь возможность достигнуть любой другой pod на этой же ноде.

Каждый pod, используя этот IP-адрес, должен иметь возможность достигнуть любой другой pod на остальных нодах.

<img src="image.png" width="700" height="70"><br>

Не имеет значения, что это за IP-адрес и к какому диапазону он принадлежит. Пока обеспечивается решение, которое заботится об автоматическом назначении IP-адресов и устанавливает связность между pod-ами на одной ноде, а также между pod-ами на разных нодах, при этом без настройки правил NAT, вы прекрасны.

Как реализовать модель, которая решает все эти требования? Существует множество сетевых решений, которые это делают (подразумеваются CNI плагины).

Но сначала попробуем решить эту проблему самостоятельно, используя уже имеющиеся у нас знания.

Предположим у нас есть кластер, состоящий из трех нод, неважно какие из них master, а какие worker.

Ноды являются частью внешней сети `192.168.30.0/24`. Соответственно ноды имеют адреса `192.168.30.131`, `192.168.30.129` и `192.168.30.xxx`.

Когда создаются контейнеры, K8s создает для них network namespaces. Для включения связности между ними, мы подключаем эти namespace к сети.

Для этого мы создаем bridge-сеть (на каждой ноде): `ip link add v-net-0 type bridge` и затем включаем ее: `ip link set dev v-net-0 up`.

Мы решили, что каждая bridge-сеть будет находится в своей собственной подсети, например `10.244.1.0/24`, `10.244.2.0/24`, `10.244.3.0/24`. Теперь назначаем IP-адреса на bridge-интерфейсы:

```bash
ip addr add 10.244.1.1/24 dev v-net-0
ip addr add 10.244.2.1/24 dev v-net-0
ip addr add 10.244.3.1/24 dev v-net-0
```

Мы создали основу. Оставшиеся шаги выполняются для каждого контейнера, каждый раз когда создается новый контейнер. Напишем для этого скрипт. Далее мы сможем запускать его для каждого контейнера.

В скрипте записаны команды для настройки двух namespaces на разных нодах. В лекции скрипт содержит команды настройки только одного namespace. То есть по одной строке из каждого блока можно убрать.

```bash
# Создаем виртуальный сетевой кабель или pipe
ip link add veth-green type veth peer name veth-green-br
ip link add veth-yellow type veth peer name veth-yellow-br

# Подключаем один конец кабеля к namespace
ip link set veth-green netns green
ip link set veth-yellow netns yellow

# Другой конец кабеля подключаем к bridge
ip link set veth-green-br master v-net-0
ip link set veth-yellow-br master v-net-0

# Включаем интерфейсы внутри namespace
ip -n green link set dev veth-green up
ip -n yellow link set dev veth-yellow up

# Включаем интерфейсы, подключенные bridge
ip link set dev veth-green-br up
ip link set dev veth-yellow-br up

# Назначаем IP-адресы на интерфейсы внутри namespace
ip -n green addr add 10.244.1.2/24 dev veth-green
ip -n yellow addr add 10.244.2.2/24 dev veth-yellow

# Прописываем маршрут для шлюза по умолчанию
ip netns exec green ip route add default via 10.244.1.1
ip netns exec yellow ip route add default via 10.244.2.1
```

Теперь контейнеры на одной ноде могут взаимодействовать друг с другом. Копируем скрипт на другие ноды и запускаем скрипт на них, чтобы назначить IP-адрес и подключить контейнеры к их собственным внутренним сетям.

Мы решили первую часть проблемы - pod-ы получили свои собственные уникальные IP-адреса и могут взаимодействовать друг с другом, находясь при этом на одной ноде.

Следующая часть - настроить взаимодействие с другими pod-ами на остальных нодах. Например pod с IP-адресом `10.244.1.2` на первой ноде хочет пингануть pod с IP-адресом `10.244.2.2` на второй ноде. На текущий момент первый pod не знает про адрес `10.244.2.2`, т.к. он находится в другой сети.

```bash
aidar@ubuntu-vm:~$ ip netns exec green ping 10.244.2.2
ping: connect: Network is unreachable
```

Запрос маршрутизируется на IP-адрес первой ноды, т.к. она является шлюзом по умолчанию. Первая нода также не знает, что адрес `10.244.2.2` находится в частной сети на второй ноде.

Добавим запись в таблицу маршрутизации первой ноды - направлять трафик, идущий к `10.244.2.2` через IP-адрес второй ноды `192.168.30.129`:

`ip route add 10.244.2.2 via 192.168.30.129`